<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flixoura - M3U Player</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* General Setup */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e4e4e7;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            position: relative; 
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #a1a1aa;
            font-size: 0.95rem;
        }

        /* Top Right Menu */
        .top-menu {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 15px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 600;
            text-decoration: none;
            color: #e4e4e7;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .menu-item .material-icons {
            margin-right: 5px;
            font-size: 18px;
        }

        /* Utility Classes */
        .flex-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Section Styles */
        .section-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Input Elements */
        textarea, input[type="text"], input[type="file"], select {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #e4e4e7;
            font-family: inherit;
            margin-bottom: 10px;
            font-size: 0.95rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        select {
            cursor: pointer;
            padding-right: 30px;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Tabs */
        .input-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e4e4e7;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Drop Zone */
        .drop-zone {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .drop-zone:hover, .drop-zone.drag-over {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .btn-player-switch {
            background: #f59e0b;
            color: #1a1a2e;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85rem;
            margin: 0;
            margin-top: 10px;
        }
        
        .episode-actions {
            display: flex;
            gap: 10px;
        }


        /* Playlist Manager */
        .playlist-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .playlist-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.2s;
        }
        
        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .playlist-name {
            cursor: pointer;
            font-size: 0.9rem;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #e4e4e7;
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 5px;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        /* Video Player */
        .player-section {
            display: none;
        }

        .player-section.active {
            display: block;
        }

        .player-container {
            width: 100%;
            max-height: 600px;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
        }

        video {
            width: 100%;
            max-height: 600px;
            background: #000;
        }

        /* PlayerJS specific styles to fit container */
        #player {
            width: 100%;
            height: 600px;
        }
        
        .player-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Playing Channel Title with Logo */
        .channel-title-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
        }

        .playing-channel-logo {
            max-width: 30px;
            max-height: 30px;
            border-radius: 5px; 
            object-fit: contain;
            filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.3));
        }

        .channel-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0; 
            line-height: 1; 
        }

        /* Episodes Grid */
        .episodes-section {
            display: none;
        }

        .episodes-section.active {
            display: block;
        }
        
        .episode-filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .episode-filters label {
            white-space: nowrap;
        }

        .episodes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .episode-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .episode-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }

        .episode-card.playing {
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
        }
        
        .episode-card.resumable::before {
            content: 'RESUME';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f59e0b;
            color: #1a1a2e;
            padding: 2px 8px;
            border-radius: 5px;
            z-index: 10;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .channel-logo {
            max-width: 100px;
            max-height: 40px;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.2));
            object-fit: contain;
        }

        .episode-group {
            color: #a1a1aa;
            font-size: 0.75rem;
            margin-bottom: 5px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .episode-title-card {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
            line-height: 1.4;
            flex-grow: 1;
        }

        /* Custom style for the non-clickable FTP Name button - FIX APPLIED HERE */
        .btn-ftp-name {
            background: #3c3c4f;
            color: #fff;
            padding: 8px 12px;
            font-size: 0.85rem;
            text-align: center;
            flex: 1; 
            cursor: default;
            opacity: 0.9; 
            white-space: normal; 
            word-break: break-all; /* FIX: Force long words/URLs to wrap */
            min-height: 40px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-ftp-name:hover {
            background: #3c3c4f;
            transform: none;
            box-shadow: none;
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
            margin-left: 10px;
        }
        
        .loading-spinner.active {
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Shortcuts Hint 3D Styling */
        .shortcuts-hint {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(145deg, #16213e, #1a1a2e); 
            border-radius: 12px; 
            box-shadow: 
                -5px -5px 15px rgba(255, 255, 255, 0.05),
                5px 5px 15px rgba(0, 0, 0, 0.5),
                inset 1px 1px 5px rgba(255, 255, 255, 0.1); 
            text-align: center;
            font-size: 0.95rem;
            color: #ccc;
            font-weight: 600; 
            line-height: 1.6; 
        }
        
        .shortcuts-hint a {
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
        }
        
        .shortcuts-hint a:hover {
            text-decoration: underline;
        }

        /* 3D Toast Notification Styles */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: linear-gradient(145deg, #16213e, #1a1a2e);
            color: #e4e4e7;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 
                -5px -5px 15px rgba(255, 255, 255, 0.05),
                5px 5px 15px rgba(0, 0, 0, 0.5),
                inset 1px 1px 5px rgba(255, 255, 255, 0.1); 
            font-weight: 600;
            min-width: 250px;
            text-align: center;
            opacity: 0;
            transform: translateY(-20px) scale(0.9);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
            white-space: pre-wrap; 
            text-align: left; 
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        
        .toast.success {
            border-left: 5px solid #4CAF50;
        }
        .toast.error {
            border-left: 5px solid #F44336;
        }
        .toast.info {
            border-left: 5px solid #667eea;
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            .top-menu {
                position: static;
                margin-top: 15px;
                justify-content: center;
            }

            .episodes-grid {
                grid-template-columns: 1fr;
            }

            .player-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .channel-title-container { 
                text-align: center;
                justify-content: center;
            }
            
            #player {
                height: 300px;
            }
            
            .toast {
                min-width: 80%;
            }
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    
    <div class="container">
        <header>
            <div class="top-menu">
                <div class="menu-item" onclick="M3UPlayer.showAbout()">
                    <span class="material-icons">info</span> About
                </div>
                <a class="menu-item" href="https://t.me/TECH_HOUSE_01" target="_blank">
                    <svg style="width:18px;height:18px;margin-right:5px;fill:#e4e4e7" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.33 7.5L14.4 16.5c-.14.39-.4.49-.71.29l-2.22-1.66-1.07 1.05c-.14.14-.26.26-.52.26l.16-2.43 4.41-4c.18-.16-.04-.25-.28-.09l-5.46 3.44-2.24-.71c-.39-.12-.49-.39-.28-.56l10-4.04c.33-.14.62-.03.52.28z"/>
                    </svg>
                    Contact
                </a>
            </div>
            <h1>üé¨ Flixoura</h1>
            <p class="subtitle">Load, manage, and stream M3U playlists with HLS support and persistence</p>
        </header>

        <div class="input-section section-card">
            <div class="input-tabs">
                <button class="tab-btn active" data-tab="paste">üìã Paste M3U</button>
                <button class="tab-btn" data-tab="upload">üìÅ Upload File</button>
                <button class="tab-btn" data-tab="url">üîó Load URL</button>
            </div>

            <div class="tab-content active" id="paste-tab">
                <textarea id="m3u-text" placeholder="Paste your M3U playlist here..."></textarea>
                <button class="btn" onclick="M3UPlayer.parseFromText()">Load Playlist</button>
            </div>

            <div class="tab-content" id="upload-tab">
                <div class="drop-zone" id="drop-zone">
                    <p>üìÇ Drag & drop .m3u file here or click to browse</p>
                </div>
                <input type="file" id="file-input" accept=".m3u,.m3u8" style="display:none;">
            </div>

            <div class="tab-content" id="url-tab">
                <div class="flex-row">
                    <input type="text" id="m3u-url" placeholder="Enter M3U URL (e.g., https://example.com/playlist.m3u)">
                    <button class="btn" id="load-url-btn" onclick="M3UPlayer.parseFromURL()">
                        Load from URL
                    </button>
                    <div class="loading-spinner" id="url-spinner"></div>
                </div>
            </div>
        </div>

        <div class="playlist-manager section-card">
            <h3>üíæ Saved Playlists</h3>
            <div class="flex-row">
                <input type="text" id="playlist-name" placeholder="Enter playlist name to save..." style="flex: 1;">
                <button class="btn btn-secondary" onclick="M3UPlayer.savePlaylist()">Save Current</button>
            </div>
            <div class="playlist-list" id="playlist-list"></div>
        </div>

        <div class="player-section section-card" id="player-section">
            <div class="player-container" id="native-player-container">
                <video id="video-player" controls></video>
                <div style="text-align: center; margin-top: 10px; font-weight: bold;">Player One (Native)</div>
            </div>
            
            <div class="player-container" id="playerjs-player-container" style="display:none;">
                <div id="player"></div>
                <div style="text-align: center; margin-top: 10px; font-weight: bold;">Player Two (Live)</div>
            </div>

            <div class="player-controls">
                
                <div class="channel-title-container">
                    <img id="playing-channel-logo" class="playing-channel-logo" src="" alt="Channel Logo" style="display: none;">
                    <div class="channel-title" id="current-channel-title">No channel selected</div>
                </div>
                
                <button class="btn btn-player-switch" id="player-switch-btn" onclick="M3UPlayer.switchPlayer()">
                    Switch to Player Two (Live)
                </button>
                
                <button class="btn btn-secondary" onclick="M3UPlayer.previousEpisode()">‚èÆ Previous</button>
                <button class="btn btn-secondary" onclick="M3UPlayer.nextEpisode()">Next ‚è≠</button>
                <button class="btn btn-secondary" onclick="M3UPlayer.closePlayer()">‚úï Close</button>
            </div>
        </div>

        <div class="episodes-section section-card" id="episodes-section">
            <h2>üì∫ Channels (<span id="episode-count">0</span>)</h2>
            <div class="episode-filters">
                <label for="episode-search">Search:</label>
                <input type="text" id="episode-search" placeholder="Filter by channel or URL..." style="width: 250px; margin-bottom: 0;">
                
                <label for="group-filter">Group:</label>
                <select id="group-filter" style="width: 200px; margin-bottom: 0;"></select>
            </div>
            
            <div class="episodes-grid" id="episodes-grid"></div>
        </div>

        
        <div class="shortcuts-hint">
            <p>Want to create your own playlist?</p>
            <p>Then, use this tool: <a href="//raw.githack.com/tvbd/iptv/main/playlist.html" target="_blank">m3u playlist</a></p>
            <p style="font-size:0.8em; opacity:0.8;">(To create new playlists or edit your existing M3U files)</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <script src="playerjs.js"></script>
    
    <script>
        // --- Configuration ---
        // NOTE: This URL contains a token which may cause Cross-Origin (CORS) security issues or be temporary.
        // If loading fails, please use the 'Paste M3U' or 'Upload File' tabs.
        const DEFAULT_PLAYLIST_URL = "https://raw.githubusercontent.com/MRM3UK/New-try/refs/heads/main/playlist5.m3u";
        const DEFAULT_PLAYLIST_NAME = "BDIX Movies Project 2 (Update)";
         

        // About Modal Content (Updated to English)
        const ABOUT_CONTENT = `
            üé¨ About Flixoura Player:

            1. Load & Stream: Easily load M3U playlists via URL, paste, or file upload.
            2. Dual Player Support: Seamlessly switch between Native and PlayerJS for optimal HLS streaming.
            3. Resume Playback: Automatically saves and resumes your last watched position (using Local Storage).
        `;
        
        // Use an object literal for encapsulation
        const M3UPlayer = (function() {
            // --- Private State ---
            let currentPlaylist = [];
            let currentEpisodeIndex = -1;
            let currentPlaylistName = 'Current Playlist';
            let hlsInstance = null;
            let playerjsInstance = null;
            let currentPlayerMode = 'native'; // 'native' or 'playerjs'
            
            // --- Load Optimization Variables ---
            const EPISODES_PER_LOAD = 50;
            let currentEpisodesLimit = EPISODES_PER_LOAD; 
            
            const VIDEO_PLAYER = document.getElementById('video-player');
            const PLAYER_JS_CONTAINER = document.getElementById('playerjs-player-container');
            const NATIVE_PLAYER_CONTAINER = document.getElementById('native-player-container');
            const PLAYER_SWITCH_BTN = document.getElementById('player-switch-btn');
            const TOAST_CONTAINER = document.getElementById('toast-container');

            // --- Playing Channel Info ---
            const PLAYING_CHANNEL_LOGO = document.getElementById('playing-channel-logo');
            const CURRENT_CHANNEL_TITLE_DIV = document.getElementById('current-channel-title');
            
            const RESUME_KEY = 'm3u_player_resume_data';

            // --- Utility Functions ---

            /** Displays a custom 3D toast notification */
            function showToast(message, type = 'info', duration = 3000) {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerText = message; 
                
                TOAST_CONTAINER.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 10);
                
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 500); 
                }, duration);
            }

            /** Escapes HTML for safe display */
            function escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                if (text === null || text === undefined) return '';
                return String(text).replace(/[&<>"']/g, (m) => map[m]);
            }
            
            /** Extracts attributes from an #EXTINF line */
            function extractAttributes(line) {
                const attrs = {};
                const regex = /([a-zA-Z0-9\-]+)\s*=\s*(?:("([^"]*)")|('([^']*)')|([^,\s]*))/g;
                let match;
                while ((match = regex.exec(line)) !== null) {
                    const value = match[3] || match[5] || match[6];
                    attrs[match[1].toLowerCase()] = value || '';
                }
                return attrs;
            }

            /** Extracts the simplified FTP/Host Name for display */
            function getFtpDisplayName(url) {
                try {
                    const parsedUrl = new URL(url);
                    let host = parsedUrl.hostname.toLowerCase();
                    
                    // 1. Remove common prefixes
                    host = host.replace(/^(www\.|index\d*\.|ftp\.)/i, '');
                    
                    // 2. Remove common suffixes 
                    host = host.replace(/(\.com|\.net|\.org|\.info|\.bd|\.xyz|\.in|\.st)$/i, '');
                    
                    // 3. Clean and capitalize
                    host = host.replace(/[\-.]/g, ' ').trim();
                    host = host.replace(/\b\w/g, c => c.toUpperCase());
                    
                    // 4. Specific replacements
                    if (host.includes('Circle')) return 'CircleFTP';
                    if (host.includes('Timepass')) return 'TimepassBD';
                    if (host.includes('Sam')) return 'SAM Online';
                    if (host.includes('Ftpbd')) return 'FTPBD';
                    if (host.includes('Discovery')) return 'DiscoveryFTP';

                    return host || 'Link Source';
                } catch (e) {
                    return 'Unknown Source'; 
                }
            }

            /** Parses M3U content into a structured list of episodes */
            function parseM3U(content) {
                if (content.includes('#EXT-X-STREAM-INF')) {
                    console.warn('Playlist seems to be a multi-variant playlist. M3U Player might only pick the first available stream URL.');
                }

                const lines = content.split('\n').map(line => line.trim()).filter(line => line);
                const episodes = [];
                let currentAttributes = {};
                let currentTitle = '';

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    if (line.startsWith('#EXTINF:')) {
                        const parts = line.split(',');
                        currentTitle = parts.slice(1).join(',').trim() || 'Untitled';
                        currentAttributes = extractAttributes(parts[0]);
                    } else if (!line.startsWith('#')) {
                        const url = line;
                        
                        episodes.push({
                            title: currentTitle || (currentAttributes['tvg-name'] || `Channel ${episodes.length + 1}`),
                            url: url,
                            group: currentAttributes['group-title'] || 'Ungrouped',
                            tvgId: currentAttributes['tvg-id'] || '',
                            tvgLogo: currentAttributes['tvg-logo'] || ''
                        });
                        
                        currentTitle = '';
                        currentAttributes = {};
                    }
                }

                return episodes;
            }
            
            // --- Resume/Persistence Logic ---

            function getResumeData() {
                const data = localStorage.getItem(RESUME_KEY);
                return data ? JSON.parse(data) : {};
            }

            function setResumeData(episodeUrl, time) {
                const data = getResumeData();
                if (time > 5) {
                    data[episodeUrl] = { time: time, timestamp: Date.now() };
                } else {
                    delete data[episodeUrl];
                }
                localStorage.setItem(RESUME_KEY, JSON.stringify(data));
                M3UPlayer.displayEpisodes();
            }
            
            function clearPlaybackPosition() {
                const episode = currentPlaylist[currentEpisodeIndex];
                if (episode) {
                    const data = getResumeData();
                    delete data[episode.url];
                    localStorage.setItem(RESUME_KEY, JSON.stringify(data));
                    M3UPlayer.displayEpisodes();
                }
            }
            
            let positionSaverInterval = null;
            function savePlaybackPosition() {
                const episode = currentPlaylist[currentEpisodeIndex];
                if (!episode) return;
                
                let currentTime = 0;
                
                if (currentPlayerMode === 'native' && VIDEO_PLAYER) {
                    currentTime = VIDEO_PLAYER.currentTime;
                } else if (currentPlayerMode === 'playerjs' && playerjsInstance && typeof playerjsInstance.api === 'function') {
                    try {
                        if (playerjsInstance.api('getDuration') > 0) {
                            currentTime = playerjsInstance.api('getPosition');
                        }
                    } catch (e) {
                        console.warn("Player.js API error during savePlaybackPosition:", e);
                        return;
                    }
                }

                if (currentTime > 0) {
                    setResumeData(episode.url, currentTime);
                }
            }

            function startPositionSaver() {
                if (positionSaverInterval) clearInterval(positionSaverInterval);
                positionSaverInterval = setInterval(savePlaybackPosition, 5000); 
            }

            function stopPositionSaver() {
                if (positionSaverInterval) clearInterval(positionSaverInterval);
                positionSaverInterval = null;
            }
            
            // --- Player/Playlist Core Functions ---

            /** Loads a new playlist, updates state, and displays the grid. */
            function loadPlaylist(episodes, name = 'Current Playlist') {
                if (episodes.length === 0) {
                    showToast('No channels found in playlist!', 'error');
                    return;
                }

                currentPlaylist = episodes;
                currentEpisodeIndex = -1;
                currentPlaylistName = name;
                document.getElementById('playlist-name').value = name;
                
                currentEpisodesLimit = EPISODES_PER_LOAD; 

                M3UPlayer.populateGroupFilter();
                M3UPlayer.displayEpisodes();
                document.getElementById('episodes-section').classList.add('active');
                showToast(`Playlist Loaded: ${name} (${episodes.length} items)`, 'success');
            }
            
            /** Plays a specific episode index */
            function playEpisode(index) {
                if (index < 0 || index >= currentPlaylist.length) return;

                currentEpisodeIndex = index;
                const episode = currentPlaylist[index];
                const resumeData = getResumeData()[episode.url];
                const startTime = resumeData ? resumeData.time : 0;
                
                stopPositionSaver();

                // --- Update Playing Channel Info (Logo + Title) ---
                CURRENT_CHANNEL_TITLE_DIV.textContent = escapeHtml(episode.title);
                if (episode.tvgLogo) {
                    PLAYING_CHANNEL_LOGO.src = escapeHtml(episode.tvgLogo);
                    PLAYING_CHANNEL_LOGO.style.display = 'inline-block';
                } else {
                    PLAYING_CHANNEL_LOGO.style.display = 'none';
                }

                document.getElementById('player-section').classList.add('active');
                
                // --- Player Cleanup ---
                VIDEO_PLAYER.removeEventListener('timeupdate', savePlaybackPosition);
                VIDEO_PLAYER.removeEventListener('ended', clearPlaybackPosition);
                if (hlsInstance) {
                    hlsInstance.destroy();
                    hlsInstance = null;
                }
                
                if (playerjsInstance) {
                    try {
                        playerjsInstance.api('destroy');
                    } catch (e) {
                        console.warn("Player.js destroy failed:", e);
                    }
                    playerjsInstance = null;
                    PLAYER_JS_CONTAINER.innerHTML = '<div id="player"></div><div style="text-align: center; margin-top: 10px; font-weight: bold;">Player Two (Live)</div>';
                }

                VIDEO_PLAYER.removeAttribute('src'); 
                VIDEO_PLAYER.load();
                
                // --- Player Initialization ---

                if (currentPlayerMode === 'native') {
                    NATIVE_PLAYER_CONTAINER.style.display = 'block';
                    PLAYER_JS_CONTAINER.style.display = 'none';
                    PLAYER_SWITCH_BTN.textContent = 'Switch to Player Two (Live)';
                    
                    if (episode.url.toLowerCase().includes('.m3u8') && Hls.isSupported()) {
                        hlsInstance = new Hls({
                            startPosition: startTime
                        });
                        hlsInstance.loadSource(episode.url);
                        hlsInstance.attachMedia(VIDEO_PLAYER);
                        hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
                            VIDEO_PLAYER.play().catch(e => console.error('Play error (MANIFEST_PARSED):', e));
                        });
                        hlsInstance.on(Hls.Events.ERROR, (event, data) => {
                            if (data.fatal) {
                                console.error('HLS Fatal Error:', data);
                                M3UPlayer.switchPlayer(true); 
                                showToast(`Player One (Native) failed. Switched to Player Two.`, 'error', 7000);
                            }
                        });
                    } else {
                        VIDEO_PLAYER.src = episode.url;
                        VIDEO_PLAYER.currentTime = startTime;
                        VIDEO_PLAYER.play().catch(e => console.error('Play error (Regular/Native HLS):', e));
                    }
                    
                    VIDEO_PLAYER.addEventListener('timeupdate', savePlaybackPosition);
                    VIDEO_PLAYER.addEventListener('ended', clearPlaybackPosition);

                } else if (currentPlayerMode === 'playerjs') {
                    NATIVE_PLAYER_CONTAINER.style.display = 'none';
                    PLAYER_JS_CONTAINER.style.display = 'block';
                    PLAYER_SWITCH_BTN.textContent = 'Switch to Player One (Native)';
                    
                    // PlayerJS Logic
                    playerjsInstance = new Playerjs({
                        id: "player",
                        file: episode.url,
                        skin: "https://playerjs.com/skins/t=video&tmp=471vq3g7qu9x",
                        title: episode.title,
                        poster: episode.tvgLogo,
                        start: startTime,
                        autoplay: true,
                        hls: true
                    });
                    
                    startPositionSaver();
                }

                M3UPlayer.displayEpisodes();
                document.getElementById('player-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            // --- Exported Methods (Public API) ---
            return {
                showAbout: function() {
                    showToast(ABOUT_CONTENT, 'info', 10000);
                },

                switchPlayer: function(forcePlay = false) {
                    const episode = currentPlaylist[currentEpisodeIndex];
                    
                    if (currentPlayerMode === 'native') {
                        currentPlayerMode = 'playerjs';
                    } else {
                        currentPlayerMode = 'native';
                    }
                    
                    showToast(`Switched to ${currentPlayerMode === 'native' ? 'Player One (Native)' : 'Player Two (Live)'}`, 'info');

                    if (episode || forcePlay) {
                        playEpisode(currentEpisodeIndex);
                    } else {
                        if (currentPlayerMode === 'native') {
                            NATIVE_PLAYER_CONTAINER.style.display = 'block';
                            PLAYER_JS_CONTAINER.style.display = 'none';
                            PLAYER_SWITCH_BTN.textContent = 'Switch to Player Two (Live)';
                        } else {
                            NATIVE_PLAYER_CONTAINER.style.display = 'none';
                            PLAYER_JS_CONTAINER.style.display = 'block';
                            PLAYER_SWITCH_BTN.textContent = 'Switch to Player One (Native)';
                        }
                    }
                },

                parseFromText: function() {
                    const content = document.getElementById('m3u-text').value;
                    if (!content.trim()) {
                        showToast('Please paste M3U content first!', 'error');
                        return;
                    }
                    const name = prompt('Enter a name for this playlist:', 'Pasted Playlist');
                    if (name) {
                        loadPlaylist(parseM3U(content), name);
                    }
                },

                parseFromURL: async function(url = document.getElementById('m3u-url').value, name = null) {
                    if (!url.trim()) {
                        showToast('Please enter a URL!', 'error');
                        return;
                    }
                    
                    const spinner = document.getElementById('url-spinner');
                    const btn = document.getElementById('load-url-btn');
                    
                    btn.disabled = true;
                    spinner.classList.add('active');
                    showToast('Loading playlist from URL...', 'info', 1500);

                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                             // CORS error often manifests as a network error, but a non-200 status is also a strong hint.
                             throw new Error(`HTTP error! Status: ${response.status}. This may be a CORS issue.`);
                        }
                        const content = await response.text();
                        
                        const playlistName = name || prompt('Enter a name for this playlist:', url.split('/').pop().split('?')[0]);
                        if (playlistName) {
                            loadPlaylist(parseM3U(content), playlistName);
                        }
                    } catch (error) {
                        console.error('Failed to load M3U from URL:', error);
                        showToast('Failed to load M3U from URL. This is likely due to a Cross-Origin (CORS) security policy. Try the "Paste M3U" or "Upload File" tabs.', 'error', 7000);
                    } finally {
                        btn.disabled = false;
                        spinner.classList.remove('active');
                    }
                },
                
                handleFileUpload: function(file) {
                    showToast(`Uploading file: ${file.name}...`, 'info', 1500);
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const content = e.target.result;
                        const name = prompt('Enter a name for this playlist:', file.name.replace(/\.[^/.]+$/, ""));
                        if (name) {
                            loadPlaylist(parseM3U(content), name);
                        }
                    };
                    reader.readAsText(file);
                },

                displayEpisodes: function() {
                    const grid = document.getElementById('episodes-grid');
                    const searchInput = document.getElementById('episode-search').value.toLowerCase();
                    const groupFilter = document.getElementById('group-filter').value;
                    const resumeData = getResumeData();
                    
                    // 1. Filter all channels
                    const filteredEpisodes = currentPlaylist.filter(episode => {
                        const title = episode.title.toLowerCase();
                        const url = episode.url.toLowerCase();
                        const group = episode.group;
                        
                        const matchesSearch = title.includes(searchInput) || url.includes(searchInput);
                        const matchesGroup = groupFilter === 'all' || group === groupFilter;
                        
                        return matchesSearch && matchesGroup;
                    });
                    
                    // 2. Determine display limit (full list if filtered, otherwise paged)
                    const isFiltered = searchInput || groupFilter !== 'all';
                    const limit = isFiltered ? filteredEpisodes.length : currentEpisodesLimit;
                    
                    grid.innerHTML = '';
                    
                    // 3. Render episodes up to the limit
                    for (let index = 0; index < limit && index < filteredEpisodes.length; index++) {
                        const episode = filteredEpisodes[index];
                        const originalIndex = currentPlaylist.findIndex(e => e === episode); 
                        
                        const isPlaying = originalIndex === currentEpisodeIndex;
                        const isResumable = resumeData[episode.url] && resumeData[episode.url].time > 5;
                        
                        const ftpDisplayName = getFtpDisplayName(episode.url);

                        const card = document.createElement('div');
                        card.className = 'episode-card';
                        if (isPlaying) card.classList.add('playing');
                        if (isResumable) card.classList.add('resumable');
                        
                        card.onclick = () => M3UPlayer.playEpisode(originalIndex); 
                        
                        const logoHtml = episode.tvgLogo 
                            ? `<img src="${escapeHtml(episode.tvgLogo)}" class="channel-logo" alt="${escapeHtml(episode.title)} Logo">`
                            : '';

                        card.innerHTML = `
                            ${logoHtml}
                            <div class="episode-group">${escapeHtml(episode.group)}</div>
                            <div class="episode-title-card">${escapeHtml(episode.title)}</div>
                            <div class="episode-actions">
                                <button class="btn btn-small" onclick="event.stopPropagation(); M3UPlayer.playEpisode(${originalIndex})">
                                    ${isPlaying ? '‚ùö‚ùö Playing' : (isResumable ? '‚ñ∂ Resume' : '‚ñ∂ Play')}
                                </button>
                                <button class="btn btn-small btn-ftp-name" onclick="event.stopPropagation();">
                                    üîó ${escapeHtml(ftpDisplayName)}
                                </button>
                            </div>
                        `;

                        grid.appendChild(card);
                    }
                    
                    document.getElementById('episode-count').textContent = filteredEpisodes.length;
                    
                    // 4. Add 'Load More' button if applicable
                    const loadMoreContainer = document.getElementById('load-more-container');
                    if (loadMoreContainer) loadMoreContainer.remove();
                    
                    if (!isFiltered && limit < filteredEpisodes.length) {
                        const container = document.createElement('div');
                        container.id = 'load-more-container';
                        container.style.textAlign = 'center';
                        container.style.marginTop = '20px';

                        const loadMoreBtn = document.createElement('button');
                        loadMoreBtn.className = 'btn btn-secondary';
                        const remaining = filteredEpisodes.length - limit;
                        loadMoreBtn.textContent = `Load ${Math.min(EPISODES_PER_LOAD, remaining)} more channels (Total: ${filteredEpisodes.length})`;
                        loadMoreBtn.onclick = M3UPlayer.loadMoreEpisodes;
                        
                        container.appendChild(loadMoreBtn);
                        document.getElementById('episodes-section').appendChild(container);
                    }
                },
                
                // --- Load More function ---
                loadMoreEpisodes: function() {
                    currentEpisodesLimit += EPISODES_PER_LOAD;
                    M3UPlayer.displayEpisodes();
                },

                populateGroupFilter: function() {
                    const select = document.getElementById('group-filter');
                    const groups = new Set(currentPlaylist.map(e => e.group));
                    
                    select.innerHTML = '<option value="all">All Groups</option>';
                    
                    Array.from(groups).sort().forEach(group => {
                        const option = document.createElement('option');
                        option.value = group;
                        option.textContent = group;
                        select.appendChild(option);
                    });
                },

                playEpisode: playEpisode,

                nextEpisode: function() {
                    if (currentPlaylist.length === 0) return;
                    const nextIndex = (currentEpisodeIndex + 1) % currentPlaylist.length;
                    playEpisode(nextIndex);
                },

                previousEpisode: function() {
                    if (currentPlaylist.length === 0) return;
                    const prevIndex = currentEpisodeIndex - 1 < 0 ? currentPlaylist.length - 1 : currentEpisodeIndex - 1;
                    playEpisode(prevIndex);
                },

                closePlayer: function() {
                    document.getElementById('player-section').classList.remove('active');
                    
                    VIDEO_PLAYER.pause();
                    VIDEO_PLAYER.removeAttribute('src');
                    VIDEO_PLAYER.load();
                    VIDEO_PLAYER.removeEventListener('timeupdate', savePlaybackPosition);
                    VIDEO_PLAYER.removeEventListener('ended', clearPlaybackPosition);
                    if (hlsInstance) {
                        hlsInstance.destroy();
                        hlsInstance = null;
                    }
                    
                    if (playerjsInstance) {
                        try {
                            playerjsInstance.api('destroy');
                        } catch (e) {
                            console.warn("Player.js destroy failed on close.", e);
                        }
                        playerjsInstance = null;
                        PLAYER_JS_CONTAINER.innerHTML = '<div id="player"></div><div style="text-align: center; margin-top: 10px; font-weight: bold;">Player Two (Live)</div>';
                    }
                    stopPositionSaver();
                    
                    currentEpisodeIndex = -1;
                    // Reset playing logo and title
                    CURRENT_CHANNEL_TITLE_DIV.textContent = 'No channel selected';
                    PLAYING_CHANNEL_LOGO.style.display = 'none';
                    PLAYING_CHANNEL_LOGO.src = '';

                    M3UPlayer.displayEpisodes();
                    
                    currentPlayerMode = 'native';
                    NATIVE_PLAYER_CONTAINER.style.display = 'block';
                    PLAYER_JS_CONTAINER.style.display = 'none';
                    PLAYER_SWITCH_BTN.textContent = 'Switch to Player Two (Live)';
                },

                savePlaylist: function() {
                    const name = document.getElementById('playlist-name').value.trim();
                    if (!name) {
                        showToast('Please enter a playlist name!', 'error');
                        return;
                    }

                    if (currentPlaylist.length === 0) {
                        showToast('No playlist loaded to save!', 'error');
                        return;
                    }

                    const playlists = M3UPlayer.getPlaylists();
                    playlists[name] = { name: name, episodes: currentPlaylist };
                    localStorage.setItem('m3u_playlists', JSON.stringify(playlists));
                    
                    currentPlaylistName = name;
                    M3UPlayer.loadPlaylistList();
                    showToast(`Playlist "${name}" saved!`, 'success');
                },

                getPlaylists: function() {
                    const data = localStorage.getItem('m3u_playlists');
                    return data ? JSON.parse(data) : {};
                },

                loadPlaylistList: function() {
                    const playlists = M3UPlayer.getPlaylists();
                    const listDiv = document.getElementById('playlist-list');
                    listDiv.innerHTML = '';

                    Object.keys(playlists).forEach(name => {
                        const item = document.createElement('div');
                        item.className = 'playlist-item';
                        
                        item.innerHTML = `
                            <span class="playlist-name" onclick="M3UPlayer.loadSavedPlaylist('${escapeHtml(name)}')">${escapeHtml(name)} (${playlists[name].episodes.length} items)</span>
                            <div class="playlist-actions">
                                <button class="icon-btn" onclick="M3UPlayer.renamePlaylist('${escapeHtml(name)}')" title="Rename">‚úèÔ∏è</button>
                                <button class="icon-btn" onclick="M3UPlayer.deletePlaylist('${escapeHtml(name)}')" title="Delete">üóëÔ∏è</button>
                            </div>
                        `;
                        
                        listDiv.appendChild(item);
                    });
                },

                loadSavedPlaylist: function(name) {
                    const playlists = M3UPlayer.getPlaylists();
                    if (playlists[name]) {
                        loadPlaylist(playlists[name].episodes, name);
                    }
                },

                deletePlaylist: function(name) {
                    if (!confirm(`Delete playlist "${name}"?`)) return;
                    
                    const playlists = M3UPlayer.getPlaylists();
                    delete playlists[name];
                    localStorage.setItem('m3u_playlists', JSON.stringify(playlists));
                    M3UPlayer.loadPlaylistList();
                    showToast(`Playlist "${name}" deleted.`, 'info');
                },

                renamePlaylist: function(oldName) {
                    const newName = prompt('Enter new name:', oldName);
                    if (!newName || newName === oldName) return;
                    
                    const playlists = M3UPlayer.getPlaylists();
                    if (playlists[newName]) {
                        showToast('A playlist with this name already exists!', 'error');
                        return;
                    }
                    
                    playlists[newName] = playlists[oldName];
                    delete playlists[oldName];
                    localStorage.setItem('m3u_playlists', JSON.stringify(playlists));
                    M3UPlayer.loadPlaylistList();
                    if (oldName === currentPlaylistName) {
                        document.getElementById('playlist-name').value = newName;
                    }
                    showToast(`Playlist renamed to "${newName}".`, 'success');
                },
                
                autoLoadDefaultPlaylist: function() {
                    M3UPlayer.parseFromURL(DEFAULT_PLAYLIST_URL, DEFAULT_PLAYLIST_NAME);
                },

                init: function() {
                    M3UPlayer.loadPlaylistList();
                    
                    document.getElementById('episode-search').addEventListener('input', M3UPlayer.displayEpisodes);
                    document.getElementById('group-filter').addEventListener('change', M3UPlayer.displayEpisodes);
                    
                    // Show Welcome Notification
                    showToast('Welcome to Flixoura! Load a playlist to start.', 'info', 5000);

                    // Auto load default playlist
                    M3UPlayer.autoLoadDefaultPlaylist();
                }
            };
        })();

        // --- Event Listeners ---
        
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`${btn.dataset.tab}-tab`).classList.add('active');
            });
        });

        // Drag and drop for file upload
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                M3UPlayer.handleFileUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                M3UPlayer.handleFileUpload(e.target.files[0]);
            }
        });

        // Keyboard shortcuts (Next/Previous only)
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                if (e.key.toLowerCase() === 'n') {
                    e.preventDefault();
                    M3UPlayer.nextEpisode();
                } else if (e.key.toLowerCase() === 'p') {
                    e.preventDefault();
                    M3UPlayer.previousEpisode();
                }
            }
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
             M3UPlayer.init();
        });
    </script>
</body>
</html>
